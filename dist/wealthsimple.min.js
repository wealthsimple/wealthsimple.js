!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";require("es6-promise").polyfill();var e=require("snakecase-keys"),t=require("./request"),r=require("./errors").AuthenticationError,i=require("./constants"),n=function(){function n(e){var r=e.clientId,h=e.clientSecret,s=e.auth,o=e.fetchAdapter,u=e.env,c=void 0===u?"sandbox":u,a=e.apiVersion,f=void 0===a?"v1":a,d=e.onAuthSuccess,l=void 0===d?null:d,p=e.onAuthRevoke,v=void 0===p?null:p,A=e.verbose,k=void 0!==A&&A;if(babelHelpers.classCallCheck(this,n),!r||"string"!=typeof r)throw new Error("Please specify a valid OAuth 'clientId'.");if(this.clientId=r,this.clientSecret=h,!i.ENVIRONMENTS.includes(c))throw new Error("Unrecognized 'env'. Please use one of: "+i.ENVIRONMENTS.join(", "));if(this.env=c,this.verbose=k,!i.API_VERSIONS.includes(f))throw new Error("Unrecognized 'apiVersion'. Please use one of: "+i.API_VERSIONS.join(", "));this.apiVersion=f,this.auth=s,o?this.fetchAdapter=o:(require("isomorphic-fetch"),"undefined"!=typeof window?this.fetchAdapter=window.fetch.bind(window):this.fetchAdapter=fetch),this.onAuthSuccess=l,this.onAuthRevoke=v,this.request=new t({client:this})}return babelHelpers.createClass(n,[{key:"resourceOwnerId",value:function(){return this.auth&&this.auth.resource_owner_id}},{key:"authExpiresAt",value:function(){if(this.auth){var e=this.auth.created_at+this.auth.expires_in;return new Date(1e3*e)}}},{key:"isAuthExpired",value:function(){var e=this.authExpiresAt();return!e||e<=new Date}},{key:"isAuthRefreshable",value:function(){return!(!this.auth||"string"!=typeof this.auth.refresh_token)}},{key:"authenticate",value:function(t){var n=this,h={};t.otp&&(h[i.OTP_HEADER]=t.otp,delete t.otp);var s=!0;t.hasOwnProperty("checkAuthRefresh")&&(s=t.checkAuthRefresh,delete t.checkAuthRefresh);var o=e(t);return Object.assign(o,{client_id:this.clientId,client_secret:this.clientSecret}),this.post("/oauth/token",{headers:h,body:o,checkAuthRefresh:s}).then(function(e){return n.auth=e,n.onAuthSuccess&&n.onAuthSuccess(e),e}).catch(function(e){throw new r(e.response,e.json)})}},{key:"refreshAuth",value:function(){if(!this.isAuthRefreshable())throw new Error("Must have a refresh_token set in order to refresh auth.");return this.authenticate({grantType:"refresh_token",refreshToken:this.auth.refresh_token,checkAuthRefresh:!1})}},{key:"revokeAuth",value:function(){var e=this;return this.post("/oauth/revoke").then(function(){e.auth=null,e.onAuthRevoke&&e.onAuthRevoke()})}},{key:"_fetch",value:function(e,t,r){var i=this,n=r.headers,h=void 0===n?{}:n,s=r.query,o=void 0===s?{}:s,u=r.body,c=void 0===u?null:u,a=r.checkAuthRefresh,f=function(){return i.isAuthExpired()||(h.Authorization="Bearer "+i.auth.access_token),i.request.fetch({method:e,path:t,headers:h,query:o,body:c})};return(void 0===a||a)&&this.isAuthRefreshable()&&this.isAuthExpired()?this.refreshAuth().then(f):f()}}]),n}();["get","patch","put","post","delete","head","options"].forEach(function(e){n.prototype[e]=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this._fetch(e.toUpperCase(),t,r)}}),module.exports=n});
//# sourceMappingURL=wealthsimple.min.js.map
