{"version":3,"file":null,"sources":["../src/index.js"],"sourcesContent":["'use strict';\n\nrequire('es6-promise').polyfill();\nconst snakeCaseKeys = require('snakecase-keys');\nconst Request = require('./request');\nconst { AuthenticationError } = require('./errors');\nconst constants = require('./constants');\n\nclass Wealthsimple {\n  constructor({\n    clientId, clientSecret, auth, fetchAdapter, env = 'sandbox', apiVersion = 'v1', onAuthSuccess = null, onAuthRevoke = null, verbose = false,\n  }) {\n    // OAuth client details:\n    if (!clientId || typeof clientId !== 'string') {\n      throw new Error('Please specify a valid OAuth \\'clientId\\'.');\n    }\n    this.clientId = clientId;\n    this.clientSecret = clientSecret;\n\n    // API environment (either 'sandbox' or 'production') and version:\n    if (!constants.ENVIRONMENTS.includes(env)) {\n      throw new Error(`Unrecognized 'env'. Please use one of: ${constants.ENVIRONMENTS.join(', ')}`);\n    }\n    this.env = env;\n\n    // Setting to `true` will add request logging.\n    this.verbose = verbose;\n\n    if (!constants.API_VERSIONS.includes(apiVersion)) {\n      throw new Error(`Unrecognized 'apiVersion'. Please use one of: ${constants.API_VERSIONS.join(', ')}`);\n    }\n    this.apiVersion = apiVersion;\n\n    // Optionally pass in existing OAuth details (access_token + refresh_token)\n    // so that the user does not have to be prompted to log in again:\n    this.auth = auth;\n\n    // Optionally allow a custom request adapter to be specified (e.g. for\n    // react-native) which must implement the `fetch` interface:\n    if (fetchAdapter) {\n      this.fetchAdapter = fetchAdapter;\n    } else {\n      require('isomorphic-fetch');\n      if (typeof window !== 'undefined') {\n        // Browser: fixes the following error:\n        // Error: TypeError: Failed to execute 'fetch' on 'Window': Illegal invocation\n        this.fetchAdapter = window.fetch.bind(window);\n      } else {\n        // Node.js:\n        this.fetchAdapter = fetch;\n      }\n    }\n\n    // Optionally allow for callbacks on certain key events:\n    this.onAuthSuccess = onAuthSuccess;\n    this.onAuthRevoke = onAuthRevoke;\n\n    this.request = new Request({ client: this });\n  }\n\n  resourceOwnerId() {\n    return this.auth && this.auth.resource_owner_id;\n  }\n\n  authExpiresAt() {\n    if (this.auth) {\n      const expiresAtTimestamp = this.auth.created_at + this.auth.expires_in;\n      return new Date(expiresAtTimestamp * 1000);\n    }\n    return undefined;\n  }\n\n  isAuthExpired() {\n    const expiresAt = this.authExpiresAt();\n    return !expiresAt || expiresAt <= new Date();\n  }\n\n  isAuthRefreshable() {\n    return !!(this.auth && typeof this.auth.refresh_token === 'string');\n  }\n\n  authenticate(attributes) {\n    const headers = {};\n    if (attributes.otp) {\n      headers[constants.OTP_HEADER] = attributes.otp;\n      delete attributes.otp;\n    }\n\n    let checkAuthRefresh = true;\n    if (attributes.hasOwnProperty('checkAuthRefresh')) {\n      ({ checkAuthRefresh } = attributes);\n      delete attributes.checkAuthRefresh;\n    }\n\n    const body = snakeCaseKeys(attributes);\n    Object.assign(body, {\n      client_id: this.clientId,\n      client_secret: this.clientSecret,\n    });\n\n    return this.post('/oauth/token', { headers, body, checkAuthRefresh })\n      .then((json) => {\n        // Save auth details for use in subsequent requests:\n        this.auth = json;\n\n        if (this.onAuthSuccess) {\n          this.onAuthSuccess(json);\n        }\n\n        return json;\n      })\n      .catch((error) => {\n        throw new AuthenticationError(error.response, error.json);\n      });\n  }\n\n  refreshAuth() {\n    if (!this.isAuthRefreshable()) {\n      throw new Error('Must have a refresh_token set in order to refresh auth.');\n    }\n    return this.authenticate({\n      grantType: 'refresh_token',\n      refreshToken: this.auth.refresh_token,\n      checkAuthRefresh: false,\n    });\n  }\n\n  revokeAuth() {\n    return this.post('/oauth/revoke')\n      .then(() => {\n        this.auth = null;\n\n        if (this.onAuthRevoke) {\n          this.onAuthRevoke();\n        }\n      });\n  }\n\n  _fetch(method, path, {\n    headers = {},\n    query = {},\n    body = null,\n    checkAuthRefresh = true,\n  }) {\n    const exeturePrimaryRequest = () => {\n      if (!this.isAuthExpired()) {\n        headers.Authorization = `Bearer ${this.auth.access_token}`;\n      }\n      return this.request.fetch({\n        method, path, headers, query, body,\n      });\n    };\n\n    if (checkAuthRefresh && this.isAuthRefreshable() && this.isAuthExpired()) {\n      // Automatically refresh auth using refresh_token, then subsequently\n      // perform the actual request:\n      return this.refreshAuth().then(exeturePrimaryRequest);\n    }\n    return exeturePrimaryRequest();\n  }\n}\n\n['get', 'patch', 'put', 'post', 'delete', 'head', 'options'].forEach((method) => {\n  Wealthsimple.prototype[method] = function (path, options = {}) {\n    return this._fetch(method.toUpperCase(), path, options);\n  };\n});\n\nmodule.exports = Wealthsimple;\n"],"names":["require","polyfill","snakeCaseKeys","Request","AuthenticationError","constants","Wealthsimple","clientId","clientSecret","auth","fetchAdapter","env","apiVersion","onAuthSuccess","onAuthRevoke","verbose","Error","ENVIRONMENTS","includes","join","API_VERSIONS","window","fetch","bind","request","client","resource_owner_id","expiresAtTimestamp","created_at","expires_in","Date","undefined","expiresAt","authExpiresAt","refresh_token","attributes","headers","otp","OTP_HEADER","checkAuthRefresh","hasOwnProperty","body","assign","post","then","json","catch","error","response","isAuthRefreshable","authenticate","method","path","query","exeturePrimaryRequest","isAuthExpired","Authorization","access_token","refreshAuth","forEach","prototype","options","_fetch","toUpperCase","module","exports"],"mappings":"AAEAA,QAAQ,aAAR,EAAuBC,QAAvB;AACA,MAAMC,gBAAgBF,QAAQ,gBAAR,CAAtB;AACA,MAAMG,UAAUH,QAAQ,WAAR,CAAhB;;eACgCA,QAAQ,UAAR;;MAAxBI,+BAAAA;;AACR,MAAMC,YAAYL,QAAQ,aAAR,CAAlB;;AAEA,MAAMM,YAAN,CAAmB;oBAGd;QADDC,QACC,QADDA,QACC;QADSC,YACT,QADSA,YACT;QADuBC,IACvB,QADuBA,IACvB;QAD6BC,YAC7B,QAD6BA,YAC7B;wBAD2CC,GAC3C;QAD2CA,GAC3C,4BADiD,SACjD;+BAD4DC,UAC5D;QAD4DA,UAC5D,mCADyE,IACzE;kCAD+EC,aAC/E;QAD+EA,aAC/E,sCAD+F,IAC/F;iCADqGC,YACrG;QADqGA,YACrG,qCADoH,IACpH;4BAD0HC,OAC1H;QAD0HA,OAC1H,gCADoI,KACpI;;;QAEG,CAACR,QAAD,IAAa,OAAOA,QAAP,KAAoB,QAArC,EAA+C;YACvC,IAAIS,KAAJ,CAAU,4CAAV,CAAN;;SAEGT,QAAL,GAAgBA,QAAhB;SACKC,YAAL,GAAoBA,YAApB;;;QAGI,CAACH,UAAUY,YAAV,CAAuBC,QAAvB,CAAgCP,GAAhC,CAAL,EAA2C;YACnC,IAAIK,KAAJ,CAAW,0CAAyCX,UAAUY,YAAV,CAAuBE,IAAvB,CAA4B,IAA5B,CAAkC,EAAtF,CAAN;;SAEGR,GAAL,GAAWA,GAAX;;;SAGKI,OAAL,GAAeA,OAAf;;QAEI,CAACV,UAAUe,YAAV,CAAuBF,QAAvB,CAAgCN,UAAhC,CAAL,EAAkD;YAC1C,IAAII,KAAJ,CAAW,iDAAgDX,UAAUe,YAAV,CAAuBD,IAAvB,CAA4B,IAA5B,CAAkC,EAA7F,CAAN;;SAEGP,UAAL,GAAkBA,UAAlB;;;;SAIKH,IAAL,GAAYA,IAAZ;;;;QAIIC,YAAJ,EAAkB;WACXA,YAAL,GAAoBA,YAApB;KADF,MAEO;cACG,kBAAR;UACI,OAAOW,MAAP,KAAkB,WAAtB,EAAmC;;;aAG5BX,YAAL,GAAoBW,OAAOC,KAAP,CAAaC,IAAb,CAAkBF,MAAlB,CAApB;OAHF,MAIO;;aAEAX,YAAL,GAAoBY,KAApB;;;;;SAKCT,aAAL,GAAqBA,aAArB;SACKC,YAAL,GAAoBA,YAApB;;SAEKU,OAAL,GAAe,IAAIrB,OAAJ,CAAY,EAAEsB,QAAQ,IAAV,EAAZ,CAAf;;;oBAGgB;WACT,KAAKhB,IAAL,IAAa,KAAKA,IAAL,CAAUiB,iBAA9B;;;kBAGc;QACV,KAAKjB,IAAT,EAAe;YACPkB,qBAAqB,KAAKlB,IAAL,CAAUmB,UAAV,GAAuB,KAAKnB,IAAL,CAAUoB,UAA5D;aACO,IAAIC,IAAJ,CAASH,qBAAqB,IAA9B,CAAP;;WAEKI,SAAP;;;kBAGc;UACRC,YAAY,KAAKC,aAAL,EAAlB;WACO,CAACD,SAAD,IAAcA,aAAa,IAAIF,IAAJ,EAAlC;;;sBAGkB;WACX,CAAC,EAAE,KAAKrB,IAAL,IAAa,OAAO,KAAKA,IAAL,CAAUyB,aAAjB,KAAmC,QAAlD,CAAR;;;eAGWC,UAAb,EAAyB;UACjBC,UAAU,EAAhB;QACID,WAAWE,GAAf,EAAoB;cACVhC,UAAUiC,UAAlB,IAAgCH,WAAWE,GAA3C;aACOF,WAAWE,GAAlB;;;QAGEE,mBAAmB,IAAvB;QACIJ,WAAWK,cAAX,CAA0B,kBAA1B,CAAJ,EAAmD;sBAAA,GACzBL,UADyB,CAC9CI,gBAD8C;;aAE1CJ,WAAWI,gBAAlB;;;UAGIE,OAAOvC,cAAciC,UAAd,CAAb;WACOO,MAAP,CAAcD,IAAd,EAAoB;iBACP,KAAKlC,QADE;qBAEH,KAAKC;KAFtB;;WAKO,KAAKmC,IAAL,CAAU,cAAV,EAA0B,EAAEP,OAAF,EAAWK,IAAX,EAAiBF,gBAAjB,EAA1B,EACJK,IADI,CACEC,IAAD,IAAU;;WAETpC,IAAL,GAAYoC,IAAZ;;UAEI,KAAKhC,aAAT,EAAwB;aACjBA,aAAL,CAAmBgC,IAAnB;;;aAGKA,IAAP;KATG,EAWJC,KAXI,CAWGC,KAAD,IAAW;YACV,IAAI3C,mBAAJ,CAAwB2C,MAAMC,QAA9B,EAAwCD,MAAMF,IAA9C,CAAN;KAZG,CAAP;;;gBAgBY;QACR,CAAC,KAAKI,iBAAL,EAAL,EAA+B;YACvB,IAAIjC,KAAJ,CAAU,yDAAV,CAAN;;WAEK,KAAKkC,YAAL,CAAkB;iBACZ,eADY;oBAET,KAAKzC,IAAL,CAAUyB,aAFD;wBAGL;KAHb,CAAP;;;eAOW;WACJ,KAAKS,IAAL,CAAU,eAAV,EACJC,IADI,CACC,MAAM;WACLnC,IAAL,GAAY,IAAZ;;UAEI,KAAKK,YAAT,EAAuB;aAChBA,YAAL;;KALC,CAAP;;;SAUKqC,MAAP,EAAeC,IAAf,SAKG;8BAJDhB,OAIC;QAJDA,OAIC,iCAJS,EAIT;4BAHDiB,KAGC;QAHDA,KAGC,+BAHO,EAGP;2BAFDZ,IAEC;QAFDA,IAEC,8BAFM,IAEN;sCADDF,gBACC;QADDA,gBACC,yCADkB,IAClB;;UACKe,wBAAwB,MAAM;UAC9B,CAAC,KAAKC,aAAL,EAAL,EAA2B;gBACjBC,aAAR,GAAyB,UAAS,KAAK/C,IAAL,CAAUgD,YAAa,EAAzD;;aAEK,KAAKjC,OAAL,CAAaF,KAAb,CAAmB;cAAA,EAChB8B,IADgB,EACVhB,OADU,EACDiB,KADC,EACMZ;OADzB,CAAP;KAJF;;QASIF,oBAAoB,KAAKU,iBAAL,EAApB,IAAgD,KAAKM,aAAL,EAApD,EAA0E;;;aAGjE,KAAKG,WAAL,GAAmBd,IAAnB,CAAwBU,qBAAxB,CAAP;;WAEKA,uBAAP;;;;AAIJ,CAAC,KAAD,EAAQ,OAAR,EAAiB,KAAjB,EAAwB,MAAxB,EAAgC,QAAhC,EAA0C,MAA1C,EAAkD,SAAlD,EAA6DK,OAA7D,CAAsER,MAAD,IAAY;eAClES,SAAb,CAAuBT,MAAvB,IAAiC,UAAUC,IAAV,EAA8B;QAAdS,OAAc,uEAAJ,EAAI;;WACtD,KAAKC,MAAL,CAAYX,OAAOY,WAAP,EAAZ,EAAkCX,IAAlC,EAAwCS,OAAxC,CAAP;GADF;CADF;;AAMAG,OAAOC,OAAP,GAAiB3D,YAAjB"}